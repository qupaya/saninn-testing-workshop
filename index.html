<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>🤓 Testing Workshop</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/night.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
		<link rel="stylesheet" href="./own-styles.css">

    <style>
      :root {
        --r-link-color: rgba(252,0,84, 1);
        --r-selection-background-color: rgb(226 0 76); 
        --r-link-color-hover: #ff3f7f;
    /* --r-link-color-dark: #d08a1d;
    --r-link-color-hover: #f3d7ac; */
    /* --r-selection-background-color: #e7ad52; */

        --r-main-font-size: 30px;
        /* --r-heading1-size: 3em;
        --r-heading2-size: 2em;
        --r-heading3-size: 1.6em;
        --r-heading4-size: 1em; */
      }
    </style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

        <section>
          <h1>Testing Workshop</h1>
          <div>🧑🏽‍💻 👩🏻‍💻 👨🏼‍💻 👩🏿‍💻 👩🏼‍💻 🧑🏻‍💻</div>
        </section>

        <section>
          <h2>Saninn Salas Díaz</h2>
          <div>
            <div class="avatar">

            </div>
            <div class="details">
              Senior Software Developer @ qupaya technologies GmbH 
              <!-- <ul>
                <li>Senior Software Developer @ qupaya technologies GmbH </li>
                <li>
                  
                </li>
              </ul> -->
            </div>
          </div>
        </section>
        <section data-auto-animate>
          <h2>Why don't we want tests?</h2>
        </section>
				<section data-auto-animate>
          <h2>Why don't we want tests?</h2>
          <ul>
            <li>Takes the double (or triple) time. <br>
                <small class="fragment">Continually testing that the requirement work without bugs take more time.</small>
            </li>
            <li>It does not prevent bugs.<br>
                <small class="fragment">It prevent to repeat the same bug (regressions!)</small>
            </li>
            <li>Costs more (because developer time is 💸💸) <br>
                <small class="fragment">see 1. + 2. 
                  <span class="fragment"> ( code </span> <span class="fragment">👉🏼 see browser</span> <span class="fragment">👉🏼 code</span> <span class="fragment">👉🏼 see browser 2 times </span> <span class="fragment">👉🏼  ad infinitum)</span></small>
            </li>
            <li>It is hard, They break all the time! <br>
                <small class="fragment">This workshop! <span class="fragment">(and a lot of practice)</span></small>
            </li>
          </ul>
        </section>

        <section><h2>Tests in our Angular Project</h2></section>
				<section>
          <ul>
            <li>Unit tests &nbsp; 👉🏼 &nbsp; jest<br>
                <small>Services, Pure Functions (helpers)</small>
              </li>
            <li>Shallow tests &nbsp; 👉🏼  &nbsp; jest + @testing-library/angular<br>
                <small>Presentation/Dummy Components</small>
              </li>
            <li>End-to-end tests &nbsp; 👉🏼 &nbsp;  Cypress<br>
                <small>Libraries, Smart Components, App Components.</small>
              </li>
          </ul>

          <div>
          <small>
            <br>
            Also see: <a href="https://blog.angular-university.io/angular-2-smart-components-vs-presentation-components-whats-the-difference-when-to-use-each-and-why/">
              Smart vs Presentation Components</a>
          </small>
        </div>
        </section>

        <!-- Tip: Dummy components can also have local provider services 😉 -->
        <section data-info="How to Develop With Tests Vertical">

          <section><h2>How to develop with tests?</h2></section>

          <section data-auto-animate><h3>After Development Testing 🤭</h3></section>
          <section data-auto-animate>
            <h3>After Development Testing 🤭</h3>
            <ul>
              <li>Tedious.<br>
                <small class="fragment">"My work is done! 🥳 <span class="fragment">... oh wait...</span> <span class="fragment">I still have to write the tests 😭".</span></small>
              </li>
              
              <li>Requires double/triple check. (Example)<br>
                  <small class="fragment"> We have to write the test, remove the production code, restore production code</small>
              </li>

              <li>"I will merge it and test it later"<br>
                <small class="fragment">`Later` is roughly equivalent to 2512 years and 19 seconds.</small> 
              </li>

              <li>Pressure problems -> Manager: "Merge it now and test it later".<br>
                <small class="fragment"> Did I already said how much time `later` equals to?</small> 
              </li>

            </ul>
          </section>

          <section data-auto-animate><h3>Test Driven Development 🥳</h3>
            #TDD
          </section>
          
          <section data-auto-animate>
            <h3>Test Driven Development 🥳</h3>
            <div class="no-markers">
              <ul>
                <li class="fragment">✅ The test are done together with the implementation.</li>
                <li class="fragment">✅ Enables you find errors before they happen.</li>
                <li class="fragment">✅ Enables you to think before code.</li>
                <li class="fragment">✅ Removes repetitive manual checks.</li>
                <li class="fragment">✅ Makes the code future proof.</li>
            </ul>
            </div>
            <div class="fragment">
              <hr />

              <h4>Contras</h4>
              <div data-markdown>
                * Hard to start (like going to the gym 💪).
                * It takes time until it feels naturally to you.
                * You have to take an stand and defend the time they take when given your time estimations.

              </div>
            </div>



          </section>
        </section>

        <section>
          <section><h2>What to test?</h2></section>

          <section data-info="What to test on services">
            <div data-markdown>
              ## Angular Services Testing
                1. Test public APIs function returns.
                1. Public state changes.
                1. External fire and forget requests.
            </div>
            
            <hr />
            <div class="fragment-replace-container">
              <div class="fragment fragment-replace-item" data-markdown>
                ```typescript []
                // Service without dependencies
                public save(objectToSave: SomeInterface): void;
                public get(id: number): SomeInterface | null;

                // ----

                test('saved locally', () => {
                  const objectToSave = {
                    id: wantedId,
                    data: 'Hello I am some object'
                  }
                  
                  service.save(objectToSave);

                  const savedObject = service.get(objectToSave.id)
                  expect(savedObject).toEqual(objectToSave);
                });
                ```
              </div>

              <div class="fragment fragment-replace-item" data-markdown>
                ```typescript []
                // Service with dependencies (For example a Backend Service)
                public save(objectToSave: SomeInterface): void;
                public get(id: number): SomeInterface | null;

                // ----

                test('saved locally', () => {
                  const objectToSave = {
                    id: wantedId,
                    data: 'Hello I am some object'
                  }
                  
                  service.save(objectToSave);

                  const savedObject = service.get(wantedId);
                  verify(SomeBackendDependencyMock.save(objectContaining(objectToSave))).once();
                });
                ```
              </div>
            </div> 
          </section>

          <section data-info="What to test on components">
            <div data-markdown>
              ## Dummy Components Testing
                1. Test visible elements.
                1. Test element changes.
                1. External fire and forget requests. (Shallow test)
                1. `@Output` events
            </div>
            
            <hr />
            <div class="fragment-replace-container"> 
              <div class="fragment fade-in-then-out fragment-replace-item" data-markdown>
                ```typescript []
                
                @Component({
                  selector: 'app-test',
                  templateUrl: './test.component.html',
                  styleUrls: ['./test.component.css']
                })
                export class TestComponent  {
                  activeFilter = '';
                
                  @Output() filter = new EventEmitter();
                
                  emit(value: string): void {
                    this.filter.emit(value);
                  }

                  // ...some more code here
                }
                  
                ```
              </div>

              <div class="fragment fade-in-then-out fragment-replace-item" >
                <div class="side-to-side-code-image" data-markdown>
                  <script type="text/template">
                    ```html []
                    <div>
                      Active Filter: {{activeFilter}}
                    </div>

                    <div>
                      <input [(ngModel)]="currentInput"/>
                    </div>

                    <div>
                      <button (click)="emit(currentInput)">
                        Filter Now
                      </button>
                    </div>
                    ```
                    ![Preview](./images/component-test-demo-view-1.png "Title")
                  </script>
                </div>
              </div>

              <div class="fragment fragment-replace-item" data-markdown>
                ```typescript []
                describe('TestComponent', () => {
                  
                  describe('When an active filter exist', () => {

                    test('the active filter should be visible when defined', async () => {
                      const activeFilter = 'Age';
                      await render(TestComponent, {
                        componentProperties: {
                          activeFilter
                        },
                      });
  
                      const activeFilterElement = await screen.getByText(activeFilter);
  
                      expect(activeFilterElement).toBeDefined();
                    });

                  });
                });
                ```
              </div>
            </div> 
          </section>

        </section>

        <section>
          <section><h2>Naming!</h2></section>

          <section>
            <div class="wrong-box">
              <h3>Don't</h3>
                <ul>
                  <li>Use one word descriptions (except for API function names).</li>
                  <li>Be too general (ie "should work").</li>
                  <li>Use too many technical terms (Array, Button, Error, etc)</li>
                </ul>
                <div data-markdown>
                  ```typescript []
                  describe('#Product', () => {
                    test('can be selected');
                  })
                  ```
              </div>
            </div>
  
            
            <div class="fragment correct-box">
              <h3>Do</h3>
              <ul>
                <li>Use specific names for public/api functions while grouping.</li>
                <li>Describe in a non technical way your environment.</li>
                <li>Provide as much context as possible to your fellow developers.</li>
  
                <div data-markdown>
                  ```typescript []
                    describe('#myPublicServiceFunction', () => {})

                    describe('when the resource is selected for deletion', () => {
                      test('is marked with a red tick', () => {});
                      test('their name is added to the "selected resources" box', () => {});
                    });
                  ```
                </div>
              </ul>
            </div>
              
               
          
  
          </section>
        </section>
        


        <!-- *************************************************************************** -->
        <!-- *************************************************************************** -->
        <!-- *************************************************************************** -->
        <!-- *************************************************************************** -->
        <section data-info="My Approach">
          <section>
            <h2>My Approach to Unit-Tests</h2>
            (Angular Service Tests)
          </section>

          <section data-auto-animate>
            <h3>Preparation</h3>
          </section>
          <section data-auto-animate>
            <h3>Preparation</h3>
            <ul>
              <li>Each public function (API) goes into their own describe block.</li>
              <li class="fragment">Layout the general expectations using <code>test.todo()</code>.
                <ul>
                  <br>
                    <li class="fragment">Sad Path<small><sup>*</sup></small>
                      <small style="display: block;">
                        <ul>
                          <li>Developer Task, think about when should my call should not work.</li>
                          <li>We always do this, even without unit tests.</li>
                        </ul>
                      </small>
                      <br>
                      
                    </li>
                    <li class="fragment">Happy Path
                      <small style="display: block;">
                        <ul>
                          <li>The requirements of the task (Jira ticket?).</li>
                        </ul>
                    </small>
                    </li>
                  <br>

                </ul>
              </li>
              <li class="fragment">Group tests with the same environment(s).</li>
            </ul>
            <br>
            <br>
            <br>
              
            <small style="display: block; text-align: right;" class="fragment">
                <div>(*) Some people like to start with the happy path.</div>
                <!-- <div>(**) Some people does not like to group similar requirements on before each.</div> -->
            </small>
              
          </section>

          <section data-markdown>
            ```typescript [2-3]
            describe('My Service', () => {

              describe('#saveResource', () => {
                test.todo('throw an error when the resource does not have any id');
                test.todo('return false if the resource was already saved');

                describe('resource with correct form', () => {
                  test.todo('returns true');
                  test.todo('saves the resource in backend');
                });
                
              });

            })
            ```               
          </section>

          <section>
            <h3>Implementation</h3>
            <ul>
              <li>Define the code that makes your first <code>test.todo()</code> fail.</li>
              <li>Write the implementation code until your test pass.</li>
              <li>Repeat 🔁</li>
            </ul>
            <br>
            <br>
            
            <div class="fragment">Refactor??</div>
          </section>

          <section data-markdown>
            ```typescript [3-18]
            describe('My Service', () => {

              let service: MyService;

              beforeEach(() => {
                service = new MyService();
              });

              describe('#saveResource', () => {

                test('throw an error when the resource does not have any id', () => {
                  const myResource: Resource = {
                    name:
                  }

                  expect(() => service.saveResource(myResource)).toThrow();
                });

                test.todo('return false if the resource was already saved');

                describe('resource with correct form', () => {
                  test.todo('returns true');
                  test.todo('saves the resource in backend');
                });
                
              });

            })
            ```               
          </section>

          <section data-markdown>
            ```typescript [7-14]
            @Injectable({
              providedIn: 'root',
            })
            export class SharedDebuggingService {

              public readonly saveResource(resource: Resource){
                /*
                  * As example here resource has an optional id.
                  * If the id where not optional, this should not be tested
                  * because typescript will complain for us
                  */
                if(!resource.id) {
                  throw new Error('No Id was found')
                }
              }

            }
            ```               
          </section>


          <section>
            <h3>Implementation (part 2)</h3>
            <ul>
              <li>Same mock configurations are defined together on <code>beforeEach()</code>.</li>
              <li>Group environment details on function with descriptive names<small><sup>*</sup></small>.</li>
            </ul>
            <br><br>

              <small style="display: block; text-align: right;" class="fragment">
                <div>* Some people does not like to group environments/requirements on <code class="inline">beforeEach()</code>.</div>
                <!-- <div>(**) Some people does not like to group similar requirements on before each.</div> -->
            </small>
          </section>

          <section data-markdown>
            ```typescript []
            describe('My Service', () => {

              describe('#loadValueFromBackend', () => {

                describe('loading when the service is initialized', () => {
                  const validToken = 'I Am valid 🤓';


                  function initializeService(): void {
                    service.start();
                    service.register('I do not know, something here');
                  }

                  beforeEach(() => {
                    when(SomeServiceProviderMock.getToken()).thenReturn(validToken);
                  });

                  test('loads the responseFromBackEnd', () => {
                    // Arrange
                    initializeService(); // Or the full function

                    // Act
                    service.loadValueFromBackend();

                    // Assert
                    expect(service.getValue().token).toBe(validToken)
                  });
                });
                
              });

            }),
            ```               
          </section>
        </section>

        <section data-info="Hands on! Test Cache Service">
          <h2>Hands on 1!</h2>
          <div data-markdown>
            Let's try to test our `CacheService`
          </div>

          <div data-markdown>
            optional: `EnvironmentService`
          </div>
        </section>

        <section data-markdown>
          * Async/FakeAsync
          * Mocking environment
            * setup
            * clean-up
            * ngOnDestroy / (takeOne?)!
            * unsubscribe
            * helper function for data (ex: getResourceFull())
          * Practice, test Environment Service. // <-- local storage

          * Component testing
            * render with testing library

          * Common pitfalls
            * Do not use Slashes on your test names, it will break debugging.
            * If you are using Services or components that render content outside your component (like popovers), you have to manually clean them! Usually `document.getElementsByTagName('body')[0].innerHTML = '';`
            * Create a wrong green test because “once()” is missing on the verify call

          </section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/zoom/zoom.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom ]
			});
		</script>
	</body>
</html>
